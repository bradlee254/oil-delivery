<script setup lang="ts">
import { onMounted } from "vue";
import { useRiderStore } from "../stores/riderStore";

const riderStore = useRiderStore();

onMounted(() => {
  riderStore.fetchAssignedRequests();
});

const handleUpdate = (id: string, nextStatus: "on_the_way" | "delivered") => {
  riderStore.updateStatus(id, nextStatus);
};
</script>

<template>
  <div class="min-h-screen bg-slate-100 p-6">
    <h1 class="text-3xl font-bold mb-4">Rider Dashboard</h1>
    <p class="text-slate-600 mb-6">View your assigned deliveries and update statuses</p>

    <div v-if="riderStore.loading" class="text-center text-slate-500 py-10">
      Loading assigned requestsâ€¦
    </div>

    <div v-if="riderStore.error" class="text-center text-red-500 py-10">
      {{ riderStore.error }}
    </div>

    <div v-if="!riderStore.loading && riderStore.requests.length === 0" class="text-center text-slate-400 py-10">
      No assigned deliveries yet.
    </div>

    <div v-if="riderStore.requests.length" class="space-y-4">
      <div v-for="req in riderStore.requests" :key="req._id" class="bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-bold">{{ req.user.name }} ({{ req.user.email }})</h2>
          <span
            class="px-2 py-1 rounded text-xs font-bold"
            :class="{
              'bg-yellow-100 text-yellow-800': req.status === 'assigned',
              'bg-blue-100 text-blue-800': req.status === 'on_the_way',
              'bg-green-100 text-green-800': req.status === 'delivered'
            }"
          >
            {{ req.status.replace('_', ' ').toUpperCase() }}
          </span>
        </div>
        <p><strong>Fuel:</strong> {{ req.fuelType }}</p>
        <p><strong>Amount:</strong> {{ req.amount }}L</p>
        <p><strong>Address:</strong> {{ req.deliveryAddress || 'N/A' }}</p>

        <div class="mt-2 flex gap-2">
          <button
            v-if="req.status === 'assigned'"
            class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm"
            @click="handleUpdate(req._id, 'on_the_way')"
          >
            Start Delivery
          </button>

          <button
            v-if="req.status === 'on_the_way'"
            class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm"
            @click="handleUpdate(req._id, 'delivered')"
          >
            Mark Delivered
          </button>
        </div>
      </div>
    </div>
  </div>
</template>
